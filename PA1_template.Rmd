---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---
The following is an analysis of the data from a personal activity device. This analysis was conducted as a project for the Reproducible Reserach class offered through Coursera. The data was forked from the github repository <https://github.com/rdpeng/RepData_PeerAssessment1>, and the analysis was guided by specific questions that can be found in the README

## Loading and preprocessing the data
1. *Load the data (i.e. read.csv())*
```{r}
# create a data frame from the read file, unless this step has 
# already been done
if (!exists("activitydata")){
        file<-unzip("activity.zip")
        activitydata<-read.csv(file = file, header = T, 
                               sep = ",", na.strings="NA")
}
```
The activitydata data frame spans 1/10/2012 through 30/11/2012.   

## What is mean total number of steps taken per day?  
1. *Make a histogram of the total number of steps taken each day*  

```{r}
# split the step record by day
allStepsByDay<-split(activitydata$steps, activitydata$date)
# sum all steps in each day
stepSumByDay<-lapply(X = allStepsByDay, FUN = sum) 
# extract all values from list
totalStepsByDay<-matrix(unlist(stepSumByDay),ncol=1) 
# plot histogram of extracted values
hist(totalStepsByDay, xlab = "total number of steps recorded each day", main = "Histogram of total recorded steps between 1/10/2012 and 30/11/2012")
```

2. *Calculate and report the mean and median total number of steps taken per day*  
```{r}
#for each day, calculate the mean of the steps taken
stepMeans<-lapply(X = allStepsByDay, function(x) mean(x, na.rm = T))
```
On any day, there are many five-minute intervals for which the number of steps recorded is 0. To accurately find the median number of steps taken *throughout the day*, these 0s must first be discarded. 
```{r}
#copy activitydata to nonZeroData
nonZeroStepData<-activitydata
#change all 0 values in nonZeroData$steps to NAs 
nonZeroStepData$steps[nonZeroStepData$steps==0]<-NA 
nonZeroStepsByDay<-split(nonZeroStepData$steps, nonZeroStepData$date)
# Calculate the median for each day
stepMedians<-lapply(X = nonZeroStepsByDay, function(x) median(x, na.rm = T))
```

The following table presents the mean and median number of steps taken for each day
```{r}
meanAndMeds<-as.data.frame(cbind(stepMeans, stepMedians))
head(meanAndMeds, 5)
```


## What is the average daily activity pattern?

1. *Make a time series plot (i.e. type = "l") of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all days (y-axis)*
```{r}
dataByInterval<-split(activitydata$steps, activitydata$interval)
avStepsByInterval<-lapply(dataByInterval, function(x) mean(x, na.rm = T))
plot(x = unique(activitydata$interval),y = avStepsByInterval, type="l", xlab = "Five Minute Intervals", ylab = "Average number of steps taken", main = "Time series plot of interval vs average steps")
```

2. *Which 5-minute interval, on average across all the days in the dataset, contains the maximum number of steps?*

```{r}
# get the values in the list avStepsByInterval 
avStepsByInterval<-matrix(unlist(avStepsByInterval),ncol=1)
# find the max of all the averages
maxAv<-max(avStepsByInterval)
# locate the index of this max value
indMax<-which(avStepsByInterval %in% maxAv)
# use the index to find the interval
lower<-unique(activitydata$interval)[indMax]
upper<-lower+5
paste("The interval containing the maximum number of steps is", lower, "(to", upper, "), and the maximum average number of steps is", maxAv, sep = " ")

```

## Imputing missing values
1. *Calculate and report the total number of missing values in the dataset (i.e. the total number of rows with NAs)*  

It makes sense that NAs only occur in steps, with all other data being automatically recorded by the device. Thus, the total number of rows with NAs is given by
```{r}
sum(is.na(activitydata$steps))
```
2. *Devise a strategy for filling in all of the missing values in the dataset. *  

Recalling the heuristics that  
-the median is most useful for describing the center of skewed distributions  
-the mean is most useful for describing symmetric distributions  
-the ratio of the mean to the median is a measure of skewness, ie: when $\frac{mean}{median}\approx1$, the distribution is symmetric; else, it is left- or right-skewed

the following imputation strategy is proposed:  
1. in each interval, use the ratio of mean to median to decide the skewness of the distribution  
2. replace NAs by the mean value of the interval if the ratio of mean to median in that interval is between 0.8 and 1.2  
3. otherwise, replace NAs with the median value of the interval  
However, after processing, many intervals will be composed of NAs only, perhaps indicating a period of regular non-movement (as in travelling to work). 
```{r}
# split nonZeroStepData (previously computed) to get data by interval
nonZeroStepsByInterval<-split(nonZeroStepData$steps, nonZeroStepData$interval)
nonZeroStepsByInterval[9]
```
In such cases, the median will be NA, and so will the ratio of mean to median. Then, NAs are replaced by the mean. 
```{r}
# Calculate the median for each interval
intervalStepMedians<-lapply(X = nonZeroStepsByInterval, function(x) median(x, na.rm = T))
#calculate the ratio of mean to median
intervalStepMedians<-matrix(unlist(intervalStepMedians), ncol = 1)
ratios<-as.vector(avStepsByInterval/intervalStepMedians)
for (i in (1:length(ratios))){
        if (is.na(ratios[i])){
                dataByInterval[[i]][which(is.na(dataByInterval[[i]]) %in% T)]<-avStepsByInterval[i]
        }else if(ratios[i] < 0.8){ 
                dataByInterval[[i]][which(is.na(dataByInterval[[i]]) %in% T)]<-avStepsByInterval[i]
        }else if (ratios[i] > 1.2){
                dataByInterval[[i]][which(is.na(dataByInterval[[i]]) %in% T)]<-avStepsByInterval[i]
        }else {
             dataByInterval[[i]][which(is.na(dataByInterval[[i]]) %in% T)]<-intervalStepMedians[i]
        }
}
#check that the missing data is successfully imputed
dataByInterval[10]
```

3. *Create a new dataset that is equal to the original dataset but with the missing data filled in.*
```{r}
allsteps<-unsplit(dataByInterval, activitydata$interval)
dates<-activitydata$date
interval<-activitydata$interval
newdf<-data.frame(allsteps, dates, interval)
```
4. *Make a histogram of the total number of steps taken each day and Calculate and report the mean and median total number of steps taken per day*  
```{r}
# split the step record by day
newAllStepsByDay<-split(newdf$allsteps, newdf$date)
# sum all steps in each day
newStepSumByDay<-lapply(X = newAllStepsByDay, FUN = sum) 
# extract all values from list
newTotalStepsByDay<-matrix(unlist(newStepSumByDay),ncol=1) 
# plot histogram of extracted values
hist(newTotalStepsByDay, xlab = "total number of steps recorded each day", main = "Total recorded steps between 1/10/2012 and 30/11/2012 (NA replaced)")
```{r}
#for each day, calculate the mean of the steps taken
newStepMeans<-lapply(X = newAllStepsByDay, function(x) mean(x, na.rm = T))
#copy activitydata to nonZeroData
newNonZeroStepData<-newdf
#change all 0 values in nonZeroData$steps to NAs 
newNonZeroStepData$steps[newNonZeroStepData$allsteps==0]<-NA 
newNonZeroStepsByDay<-split(newNonZeroStepData$allsteps, 
                            newNonZeroStepData$date)
# Calculate the median for each day
newStepMedians<-lapply(X = newNonZeroStepsByDay, 
                       function(x) median(x, na.rm = T))
newMeanAndMeds<-as.data.frame(cbind(newStepMeans, newStepMedians, stepMeans, stepMedians))
head(newMeanAndMeds, 200)
```

## Are there differences in activity patterns between weekdays and weekends?
